<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalshi Trading Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e17;--card:#111827;--border:#1e2a3a;--text:#e2e8f0;--dim:#64748b;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--yellow:#eab308;--accent:#6366f1}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;line-height:1.5}
.header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--border);background:var(--card)}
.header h1{font-size:20px;font-weight:700;color:#fff}
.header .ts{color:var(--dim);font-size:12px}
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);margin-right:6px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.grid{display:grid;gap:16px;padding:16px 24px;max-width:1600px;margin:0 auto}
.top-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
.card h3{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-bottom:8px}
.card .val{font-size:24px;font-weight:700}
.card .sub{font-size:12px;color:var(--dim);margin-top:4px}
.pos{color:var(--green)}.neg{color:var(--red)}
.main-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:900px){.main-grid{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:8px 10px;border-bottom:1px solid var(--border);color:var(--dim);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
td{padding:7px 10px;border-bottom:1px solid #1a2332}
tr:hover{background:#ffffff06}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}
.badge-yes{background:#22c55e22;color:var(--green)}
.badge-no{background:#ef444422;color:var(--red)}
.badge-buy{background:#3b82f622;color:var(--blue)}
.badge-sell{background:#eab30822;color:var(--yellow)}
.opp-card{padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;background:#0d1321}
.opp-card .ticker{font-weight:700;color:#fff}
.opp-card .edge{color:var(--green);font-weight:600}
.news-item{padding:10px;border-left:3px solid var(--accent);margin-bottom:8px;background:#0d1321;border-radius:0 6px 6px 0}
.news-item .headline{font-weight:600;color:#fff;font-size:13px}
.news-item .meta{font-size:11px;color:var(--dim);margin-top:4px}
.chart-wrap{position:relative;height:250px}
.risk-bar{height:6px;background:#1e2a3a;border-radius:3px;margin-top:6px;overflow:hidden}
.risk-bar .fill{height:100%;border-radius:3px;transition:width .5s}
.loading{text-align:center;padding:60px;color:var(--dim);font-size:16px}
.scroll-table{max-height:350px;overflow-y:auto}
.scroll-table::-webkit-scrollbar{width:4px}
.scroll-table::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>
<div class="header">
  <h1><span class="status-dot"></span>Kalshi Trading Dashboard</h1>
  <div class="ts" id="lastUpdate">Loading...</div>
</div>
<div class="grid">
  <div class="top-cards" id="topCards"></div>
  <div id="riskSection"></div>
  <div class="card"><h3>Price History</h3><div class="chart-wrap"><canvas id="priceChart"></canvas></div></div>
  <div class="main-grid">
    <div class="card"><h3>Positions</h3><div class="scroll-table" id="posTable"></div></div>
    <div class="card"><h3>Recent Trades</h3><div class="scroll-table" id="tradeLog"></div></div>
  </div>
  <div class="main-grid">
    <div class="card"><h3>Top Opportunities</h3><div id="opps"></div></div>
    <div class="card"><h3>News Signals</h3><div id="news"></div></div>
  </div>
</div>
<script>
let chart=null;
function fmt(v,d=2){return v==null?'--':typeof v==='number'?v.toFixed(d):''+v}
function fmtUSD(v){return v==null?'--':'$'+Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}
function pnlClass(v){return v>0?'pos':v<0?'neg':''}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}

function renderTopCards(d){
  const a=d.account||{}, r=d.risk||{};
  const cards=[
    {label:'Balance',val:fmtUSD(a.balance),sub:'Available cash'},
    {label:'Portfolio Value',val:fmtUSD(a.portfolio_value),sub:'Total positions value'},
    {label:'Total P&L',val:fmtUSD(a.total_pnl),cls:pnlClass(a.total_pnl),sub:(a.total_pnl_pct!=null?fmt(a.total_pnl_pct,1)+'%':'')},
    {label:'Open Positions',val:''+(d.positions||[]).length,sub:'Active markets'},
  ];
  document.getElementById('topCards').innerHTML=cards.map(c=>`<div class="card"><h3>${c.label}</h3><div class="val ${c.cls||''}">${c.val}</div><div class="sub">${c.sub}</div></div>`).join('');
}

function renderRisk(d){
  const r=d.risk||{};
  const metrics=[
    {label:'Exposure',val:fmt(r.exposure_pct,1)+'%',pct:r.exposure_pct||0,color:r.exposure_pct>80?'var(--red)':r.exposure_pct>50?'var(--yellow)':'var(--green)'},
    {label:'Max Drawdown',val:fmt(r.max_drawdown_pct,1)+'%',pct:Math.abs(r.max_drawdown_pct||0),color:'var(--red)'},
    {label:'Diversification',val:fmt(r.diversification_score,0)+'/100',pct:r.diversification_score||0,color:'var(--blue)'},
  ];
  document.getElementById('riskSection').innerHTML=`<div class="card"><h3>Risk Metrics</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">${metrics.map(m=>`<div><div style="display:flex;justify-content:space-between"><span>${m.label}</span><span style="font-weight:700">${m.val}</span></div><div class="risk-bar"><div class="fill" style="width:${Math.min(m.pct,100)}%;background:${m.color}"></div></div></div>`).join('')}</div></div>`;
}

function renderPositions(d){
  const p=d.positions||[];
  if(!p.length){document.getElementById('posTable').innerHTML='<p style="color:var(--dim);padding:20px">No open positions</p>';return}
  let h='<table><thead><tr><th>Ticker</th><th>Side</th><th>Qty</th><th>Entry</th><th>Current</th><th>P&L</th><th>Expiry</th></tr></thead><tbody>';
  p.forEach(r=>{
    const side=r.side||'yes';
    h+=`<tr><td style="font-weight:600">${esc(r.ticker)}</td><td><span class="badge badge-${side}">${side.toUpperCase()}</span></td><td>${r.quantity||0}</td><td>${fmt(r.entry_price)}c</td><td>${fmt(r.current_price)}c</td><td class="${pnlClass(r.pnl)}">${fmtUSD(r.pnl)}</td><td style="color:var(--dim);font-size:12px">${esc(r.expiry||'')}</td></tr>`;
  });
  h+='</tbody></table>';
  document.getElementById('posTable').innerHTML=h;
}

function renderTrades(d){
  const t=d.recent_trades||[];
  if(!t.length){document.getElementById('tradeLog').innerHTML='<p style="color:var(--dim);padding:20px">No recent trades</p>';return}
  let h='<table><thead><tr><th>Time</th><th>Ticker</th><th>Side</th><th>Qty</th><th>Price</th></tr></thead><tbody>';
  t.slice(0,20).forEach(r=>{
    const action=r.action||r.side||'buy';
    h+=`<tr><td style="color:var(--dim);font-size:12px">${esc(r.time||r.created_time||'')}</td><td style="font-weight:600">${esc(r.ticker)}</td><td><span class="badge badge-${action}">${action.toUpperCase()}</span></td><td>${r.quantity||r.count||0}</td><td>${fmt(r.price)}c</td></tr>`;
  });
  h+='</tbody></table>';
  document.getElementById('tradeLog').innerHTML=h;
}

function renderOpps(d){
  const o=d.opportunities||[];
  if(!o.length){document.getElementById('opps').innerHTML='<p style="color:var(--dim)">No opportunities found</p>';return}
  document.getElementById('opps').innerHTML=o.slice(0,8).map(r=>`<div class="opp-card"><div style="display:flex;justify-content:space-between"><span class="ticker">${esc(r.ticker||r.market)}</span><span class="edge">Edge: ${fmt(r.edge||r.expected_edge,1)}%</span></div><div style="color:var(--dim);font-size:12px;margin-top:4px">${esc(r.title||r.event||'')} | Price: ${fmt(r.price||r.yes_price)}c | ${esc(r.signal||r.recommendation||'')}</div></div>`).join('');
}

function renderNews(d){
  const n=d.news_signals||[];
  if(!n.length){document.getElementById('news').innerHTML='<p style="color:var(--dim)">No news signals</p>';return}
  document.getElementById('news').innerHTML=n.slice(0,8).map(r=>`<div class="news-item"><div class="headline">${esc(r.headline||r.title)}</div><div class="meta">${esc(r.source||'')} | Impact: ${esc(r.impact||r.sentiment||'neutral')} | ${esc(r.time||r.date||'')}</div></div>`).join('');
}

function renderChart(d){
  const hist=d.price_history||[];
  if(!hist.length)return;
  const datasets=[];
  const labels=hist.map(h=>h.date||h.time||'');
  // Support either single series or multi-ticker
  if(hist[0]&&typeof hist[0].price==='number'){
    datasets.push({label:'Portfolio',data:hist.map(h=>h.price),borderColor:'#6366f1',backgroundColor:'#6366f122',fill:true,tension:.3,pointRadius:0,borderWidth:2});
  } else {
    const tickers=Object.keys(hist[0]).filter(k=>k!=='date'&&k!=='time');
    const colors=['#6366f1','#22c55e','#ef4444','#eab308','#3b82f6','#ec4899'];
    tickers.forEach((t,i)=>{
      datasets.push({label:t,data:hist.map(h=>h[t]),borderColor:colors[i%colors.length],tension:.3,pointRadius:0,borderWidth:2,fill:false});
    });
  }
  if(chart)chart.destroy();
  chart=new Chart(document.getElementById('priceChart'),{type:'line',data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}},scales:{x:{ticks:{color:'#475569',maxTicksLimit:10,font:{size:10}},grid:{color:'#1e2a3a'}},y:{ticks:{color:'#475569',font:{size:10}},grid:{color:'#1e2a3a'}}}}});
}

async function load(){
  try{
    const r=await fetch('kalshi_dashboard_data.json?t='+Date.now());
    if(!r.ok)throw new Error(r.status);
    const d=await r.json();
    document.getElementById('lastUpdate').textContent='Last update: '+(d.last_updated||new Date().toISOString());
    renderTopCards(d);renderRisk(d);renderPositions(d);renderTrades(d);renderOpps(d);renderNews(d);renderChart(d);
  }catch(e){
    document.getElementById('lastUpdate').textContent='Error loading data: '+e.message;
  }
}
load();
setInterval(load,60000);
</script>
</body>
</html>
